name: Documentation Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install markdownlint-cli
      run: npm install -g markdownlint-cli
      
    - name: Run markdownlint
      run: |
        markdownlint '**/*.md' --ignore node_modules --config .markdownlint.json || true
      continue-on-error: true
      
  link-checker:
    name: Check Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install markdown-link-check
      run: npm install -g markdown-link-check
      
    - name: Check links in markdown files
      run: |
        find . -name "*.md" -not -path "./node_modules/*" -exec markdown-link-check {} \; || true
      continue-on-error: true
      
  structure-validation:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check required files
      run: |
        echo "Checking for required files..."
        
        required_files=(
          "README.md"
          "LICENSE"
          "CONTRIBUTING.md"
          "AUDIT_REPORT.md"
          ".github/SECURITY.md"
          "docs/genesis/FOUNDATION.md"
          "docs/genesis/BUNDLE.md"
          "docs/genesis/LEXICON.md"
          "docs/SYF_CORE.md"
          "docs/CORE_AXIOMS.md"
        )
        
        missing=0
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            missing=$((missing + 1))
          else
            echo "✅ Found: $file"
          fi
        done
        
        if [ $missing -gt 0 ]; then
          echo ""
          echo "❌ $missing required file(s) missing"
          exit 1
        else
          echo ""
          echo "✅ All required files present"
        fi
        
    - name: Verify canonical markings
      run: |
        echo "Checking canonical document markings..."
        
        canonical_docs=(
          "docs/genesis/FOUNDATION.md"
          "docs/genesis/BUNDLE.md"
          "docs/genesis/LEXICON.md"
          "docs/SYF_CORE.md"
          "docs/CORE_AXIOMS.md"
          "docs/SyFF.md"
          "docs/R.md"
          "docs/FIREPLANK.md"
        )
        
        unmarked=0
        for doc in "${canonical_docs[@]}"; do
          if [ -f "$doc" ]; then
            if grep -q "STATUS: CANON" "$doc"; then
              echo "✅ $doc properly marked as canonical"
            else
              echo "⚠️  $doc missing canonical status marking"
              unmarked=$((unmarked + 1))
            fi
          fi
        done
        
        if [ $unmarked -gt 0 ]; then
          echo ""
          echo "⚠️  $unmarked document(s) missing canonical status"
        else
          echo ""
          echo "✅ All canonical documents properly marked"
        fi
